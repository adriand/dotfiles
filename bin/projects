#!/usr/bin/env bash

list() {
  cat "$HOME/.projects"
}

build() {
  echo "$DOTFILES" | tee "$HOME/.projects"

  find "$CODE_ROOT" -type d -name '.git' | while read repository; do
    dirname "$repository" | ag -v "/\." | tee -a "$HOME/.projects"
  done
}

guess() {
  projects=$(list | xargs -n 1 basename)
  match=$(echo "$projects" | matcher "$1" --limit 1)

  list | ag "$match$"
}

new() {
  cd "$CODE_ROOT"

  if echo "$1" | ag "\.git$" &> /dev/null; then
    git clone "$1" > /dev/null
  else
    git init "$1" > /dev/null
  fi

  echo -n "$CODE_ROOT/"
  ls -t | head -n 1

  build &>/dev/null & # rebuild the list
}

command="$1"; shift
case "$command" in
  "") list $* ;;
  "build") build $* ;;
  "guess") guess $* ;;
  "new") new $* ;;
  *) echo "wtf are you doing" 1>&2 ;;
esac
